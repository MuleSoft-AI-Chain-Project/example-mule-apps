<!-- Modal for viewing full agent response JSON -->
<!-- (removed) -->
<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <!-- Messages will be injected by JS -->
    </div>
    <div class="input-group">
        <input type="text" class="form-control" id="promptInput" placeholder="Type your message here..." aria-label="Your message">
        <button class="btn btn-primary" id="sendButton">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Create a namespace for conversation functionality
window.ConversationManager = (function() {
    // Private variables
    let websocket = null;
    let currentReasoningUpdates = [];
    let responseReasoningMap = new Map();
    let typingIntervalId = null;
    let eventListeners = new Map(); // Track event listeners for cleanup

    // Function to add and track event listeners
    function addTrackedEventListener(element, event, handler) {
        if (!element) return;
        element.addEventListener(event, handler);
        if (!eventListeners.has(element)) {
            eventListeners.set(element, []);
        }
        eventListeners.get(element).push({ event, handler });
    }

    // Initialize function
    function init() {
        // Prevent multiple initializations
        if (window.ConversationManager._initialized) {
            console.log('ConversationManager already initialized, skipping...');
            return;
        }
        
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        const newConversationBtn = document.getElementById('newConversationBtn');

        if (!promptInput || !sendButton || !chatMessages) {
            console.error('Required elements not found in init');
            return;
        }

        // Mark as initialized
        window.ConversationManager._initialized = true;

        // Initialize WebSocket connection
        let a2aSessionId = generateUUID();
        createWebSocketConnection(a2aSessionId, handleWebSocketMessage);

        // Setup New Conversation button
        if (newConversationBtn) {
            addTrackedEventListener(newConversationBtn, 'click', function() {
                if (websocket) {
                    websocket.close();
                    websocket = null;
                }
                a2aSessionId = generateUUID();
                currentReasoningUpdates = [];
                responseReasoningMap.clear();
                chatMessages.innerHTML = '';
                addMessage("Hello! I'm your Host Agent. How can I help you today?", false);
                if (promptInput) promptInput.value = '';
                createWebSocketConnection(a2aSessionId, handleWebSocketMessage);
            });
        }

        // Clean up any existing interaction modal
        if (document.getElementById('interactionModal')) {
            document.getElementById('interactionModal').remove();
        }

        // Define send message handler
        async function handleSendMessage() {
            const promptInput = document.getElementById('promptInput');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!promptInput || !chatMessages) {
                console.error('Required elements not found in handleSendMessage');
                return;
            }
            
            const prompt = promptInput.value.trim();
            if (!prompt) return;
            
            addMessage(prompt, true);
            promptInput.value = '';
            addTypingMessage();
            
            currentReasoningUpdates = [];
            
            if (!websocket || websocket.readyState === WebSocket.CLOSED || websocket.readyState === WebSocket.CLOSING) {
                createWebSocketConnection(a2aSessionId, handleWebSocketMessage);
            }
            
            if (websocket.readyState === WebSocket.OPEN) {
                sendPromptMessage(prompt);
            } else if (websocket.readyState === WebSocket.CONNECTING) {
                websocket.onopen = function() {
                    sendPromptMessage(prompt);
                };
            } else {
                console.error('WebSocket is not in a valid state:', websocket.readyState);
                addMessage('Sorry, there was an error with the connection.', false, null, true);
            }
        }

        function sendPromptMessage(prompt) {
            const reasoningEngine = window.getReasoningEngine();
            const useTrustLayer = reasoningEngine === 'einstein';
            const message = JSON.stringify({ 
                prompt: prompt,
                useTrustLayer: useTrustLayer
            });
            websocket.send(message);
        }

        // Add event listeners with tracking
        addTrackedEventListener(sendButton, 'click', handleSendMessage);
        addTrackedEventListener(promptInput, 'keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // Add initial message if chat is empty
        if (chatMessages.children.length === 0) {
            addMessage("Hello! I'm your Host Agent. How can I help you today?", false);
        }
    }

    // Cleanup function
    function cleanup() {
        // Close websocket if open
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.close();
            websocket = null;
        }

        // Clear any intervals
        if (typingIntervalId) {
            clearInterval(typingIntervalId);
            typingIntervalId = null;
        }

        // Remove all tracked event listeners
        eventListeners.forEach((listeners, element) => {
            listeners.forEach(({ event, handler }) => {
                element.removeEventListener(event, handler);
            });
        });
        eventListeners.clear();

        // Clear data structures
        currentReasoningUpdates = [];
        responseReasoningMap.clear();
        
        // Reset initialization flag
        window.ConversationManager._initialized = false;
    }

    function handleWebSocketMessage(event) {
        if (event.data) {
            try {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);
                
                if (data.type === 'update') {
                    const updateObj = {
                        content: data.content,
                        timestamp: data.timestamp || new Date().toISOString()
                    };
                    currentReasoningUpdates.push(updateObj);
                    updateTypingMessageWithReasoning();
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } else if (data.response) {
                    const responseId = generateUUID();
                    responseReasoningMap.set(responseId, [...currentReasoningUpdates]);
                    addMessage(data.response, false, data, true, responseId);
                    
                    const sessionHistory = JSON.parse(localStorage.getItem('agent_sessions') || '[]');
                    sessionHistory.push({
                        interactionId: generateUUID(),
                        timestamp: new Date().toISOString(),
                        data: data
                    });
                    localStorage.setItem('agent_sessions', JSON.stringify(sessionHistory));
                    
                    currentReasoningUpdates = [];
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        }
    }

    // Utility to load the shared session modal and script, and ensure no duplicates
    function ensureSessionModalLoaded(callback) {
        console.log('ensureSessionModalLoaded called');
        const chatContainer = document.querySelector('.chat-container');
        const modal = document.getElementById('interactionModal');
        if (modal && typeof window.renderInteractionModal === 'function') {
            console.log('Modal already exists and function is available, calling callback');
            callback();
            return;
        }
        if (modal) { modal.remove(); console.log('Removed old modal'); }
        if (window.renderInteractionModal) { delete window.renderInteractionModal; console.log('Deleted old renderInteractionModal'); }
        fetch('/ui/interaction-modal.html')
            .then(resp => resp.text())
            .then(html => {
                console.log('Fetched interaction-modal.html');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const modalEl = tempDiv.querySelector('#interactionModal');
                if (modalEl) {
                    document.body.appendChild(modalEl);
                    console.log('Appended modal to document.body');
                    setupModalFocusManagement(modalEl);
                } else {
                    console.warn('No modalEl found in fetched HTML');
                }
                const scriptTag = tempDiv.querySelector('script');
                if (scriptTag) {
                    const newScript = document.createElement('script');
                    newScript.textContent = scriptTag.textContent;
                    document.body.appendChild(newScript);
                    document.body.removeChild(newScript);
                    console.log('Executed modal script');
                } else {
                    console.warn('No script tag found in fetched HTML');
                }
                setTimeout(function() {
                    console.log('Calling callback after modal/script load');
                    callback();
                }, 50);
            })
            .catch(err => {
                console.error('Failed to load interaction-modal.html:', err);
                alert('Could not load session modal.');
            });
    }

    function setupModalFocusManagement(modal) {
        if (!modal) return;
        let closeBtn = modal.querySelector('.btn-close');
        if (!closeBtn) {
            const observer = new MutationObserver(() => {
                closeBtn = modal.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        let focusTarget = document.querySelector('.sidebar .nav-link.active') || document.body;
                        if (focusTarget) {
                            focusTarget.focus();
                            console.log('[Conversation] Focused safe element on close button click (observer)');
                        }
                    });
                    observer.disconnect();
                }
            });
            observer.observe(modal, { childList: true, subtree: true });
        } else {
            closeBtn.addEventListener('click', function() {
                let focusTarget = document.querySelector('.sidebar .nav-link.active') || document.body;
                if (focusTarget) {
                    focusTarget.focus();
                }
            });
        }
        modal.addEventListener('hide.bs.modal', function() {
            let focusTarget = document.querySelector('.sidebar .nav-link.active') || document.body;
            if (focusTarget) {
                focusTarget.focus();
            }
        });
    }

    // Session ID logic for conversation
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // WebSocket connection management
    function createWebSocketConnection(sessionId, messageHandler) {
        if (websocket && (websocket.readyState === WebSocket.CLOSED || websocket.readyState === WebSocket.CLOSING)) {
            websocket = null;
        }
        
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            console.log('Reusing existing WebSocket connection');
            return websocket;
        }
        
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        const userSessionId = getCookie('userSessionId');
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = new URL('/ws/prompt', window.location.origin.replace(/^https?:/, protocol));
        wsUrl.searchParams.set('userSessionId', userSessionId || '');
        wsUrl.searchParams.set('sessionId', sessionId);
        
        console.log('Creating WebSocket connection to:', wsUrl.toString());
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function(event) {
            console.log('WebSocket connection established');
        };
        
        websocket.onmessage = messageHandler;
        
        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            if (messageHandler) {
                messageHandler({ data: JSON.stringify({ error: 'Connection error' }) });
            }
        };
        
        websocket.onclose = function(event) {
            console.log('WebSocket connection closed:', event.code, event.reason);
            if (websocket === this) {
                websocket = null;
            }
        };
        
        return websocket;
    }

    function updateTypingMessageWithReasoning() {
        const typingMsg = document.getElementById('typingMessage');
        const chatMessages = document.getElementById('chatMessages');
        
        if (!typingMsg || !chatMessages) {
            console.error('Required elements not found in updateTypingMessageWithReasoning');
            return;
        }
        
        const reasoningText = currentReasoningUpdates.map(update => {
            const timestamp = update.timestamp ? `[${update.timestamp}] ` : '';
            return timestamp + update.content;
        }).join('\n\n');
        typingMsg.innerHTML = `<div class="reasoning-updates">${marked.parse(reasoningText)}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessage(message, isUser = false, agentInfo = null, replaceTyping = false, responseId = null) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) {
            console.error('chatMessages element not found');
            return;
        }
        
        const defaultAvatar = `<svg class="engine-logo" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18" viewBox="0 0 512 512"><circle r="256" cx="256" cy="256" fill="#cfe9fe"/><g transform="matrix(0.97,0,0,0.97,7.68,22.68)"><path d="M335.2 279.9c21.2-21.2 32.8-49.3 32.8-79.3 0-29.9-11.7-58.1-32.8-79.3l-26.4 26.4c14.1 14.1 21.9 32.9 21.9 52.8 0 20-7.8 38.7-21.9 52.9zM176.7 279.9l26.4-26.4c-29.1-29.1-29.1-76.6 0-105.7l-26.4-26.4c-43.7 43.6-43.7 114.8 0 158.5z" fill="#0176d3"/><path d="m388.1 68.5-26.4 26.4c28.2 28.2 43.8 65.8 43.8 105.7s-15.5 77.5-43.8 105.7l26.4 26.4c35.3-35.3 54.7-82.2 54.7-132.1s-19.4-96.8-54.7-132.1zM150.3 94.9l-26.4-26.4c-72.9 72.8-72.9 191.4 0 264.2l26.4-26.4C92 248 92 153.2 150.3 94.9zM274.6 232.8c2.8-1.6 5.4-3.5 7.7-5.8 7.1-7.1 10.9-16.4 10.9-26.4s-3.9-19.4-10.9-26.4c-14.1-14.1-38.7-14.1-52.8 0-7.1 7.1-10.9 16.4-10.9 26.4s3.9 19.4 10.9 26.4c2.3 2.3 5 4.2 7.7 5.8v173.3h-74.7v37.4h186.8v-37.4h-74.7z" fill="#0176d3"/></g></svg>`;

        if (replaceTyping) {
            const typingMsg = document.getElementById('typingMessage');
            if (typingMsg) {
                if (typingIntervalId) {
                    clearInterval(typingIntervalId);
                    typingIntervalId = null;
                }
                typingMsg.removeAttribute('id');
                typingMsg.className = 'message agent-message';
                const reasoningEngine = window.getReasoningEngine ? window.getReasoningEngine() : 'inference';
                const avatarHtml = window.ENGINE_INFO && window.ENGINE_INFO[reasoningEngine] ? 
                    window.ENGINE_INFO[reasoningEngine].svg : defaultAvatar;
                typingMsg.innerHTML = `<div style='display:flex;align-items:flex-start;'><span style='margin-right:8px;'>${avatarHtml}</span><span style='flex:1;'>${marked.parse(message)}</span></div>`;
                
                // Add reasoning expand/collapse functionality
                if (responseId && responseReasoningMap.has(responseId)) {
                    const reasoningUpdates = responseReasoningMap.get(responseId);
                    if (reasoningUpdates.length > 0) {
                        const reasoningContainer = document.createElement('div');
                        reasoningContainer.className = 'reasoning-container';
                        
                        const reasoningToggle = document.createElement('button');
                        reasoningToggle.className = 'btn btn-sm btn-outline-secondary reasoning-toggle';
                        reasoningToggle.textContent = 'Show Chain of Thoughts';
                        reasoningToggle.onclick = function() {
                            const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                            if (reasoningContent.style.display === 'none' || !reasoningContent.style.display) {
                                reasoningContent.style.display = 'block';
                                reasoningToggle.textContent = 'Hide Chain of Thoughts';
                            } else {
                                reasoningContent.style.display = 'none';
                                reasoningToggle.textContent = 'Show Chain of Thoughts';
                            }
                        };
                        
                        const reasoningContent = document.createElement('div');
                        reasoningContent.className = 'reasoning-content';
                        reasoningContent.style.display = 'none';
                        const reasoningText = reasoningUpdates.map(update => {
                            const timestamp = update.timestamp ? `[${update.timestamp}] ` : '';
                            return timestamp + update.content;
                        }).join('\n\n');
                        reasoningContent.innerHTML = `<div class="reasoning-updates">${marked.parse(reasoningText)}</div>`;
                        
                        reasoningContainer.appendChild(reasoningToggle);
                        reasoningContainer.appendChild(reasoningContent);
                        typingMsg.appendChild(reasoningContainer);
                    }
                }
                
                // Create bottom section with pills on left and toxicity on right
                if (agentInfo) {
                    const bottomSection = document.createElement('div');
                    bottomSection.className = 'message-bottom-section';
                    
                    // Pills logic (left side)
                    const pillsContainer = document.createElement('div');
                    pillsContainer.className = 'pills-container';
                    let agentNames = [];
                    if (Array.isArray(agentInfo.reasoning)) {
                        agentInfo.reasoning.forEach(r => {
                            if (Array.isArray(r.calledAgents)) {
                                r.calledAgents.forEach(a => {
                                    if (a.agentName && !agentNames.includes(a.agentName)) {
                                        agentNames.push(a.agentName);
                                    }
                                });
                            }
                        });
                    }
                    if (agentNames.length === 0) {
                        const noAgentPill = document.createElement('span');
                        noAgentPill.className = 'agent-pill';
                        noAgentPill.textContent = 'No Remote Agent Used';
                        pillsContainer.appendChild(noAgentPill);
                    } else {
                        if (typeof agentInfo.replanCount !== 'undefined' && agentInfo.replanCount !== null) {
                            const replanPill = document.createElement('span');
                            replanPill.className = 'agent-pill green';
                            replanPill.textContent = `Replan Count: ${agentInfo.replanCount}`;
                            replanPill.style.cursor = 'pointer';
                            replanPill.title = 'Click to view session details';
                            replanPill.addEventListener('click', function(e) {
                                console.log('Green replan pill clicked, will load modal');
                                ensureSessionModalLoaded(function() {
                                    console.log('ensureSessionModalLoaded callback, about to show modal');
                                    if (typeof window.renderInteractionModal === 'function') {
                                        window.renderInteractionModal(agentInfo);
                                        let interactionModal = document.getElementById('interactionModal');
                                        if (window.bootstrap && interactionModal) {
                                            let interactionModalInstance = window.bootstrap.Modal.getOrCreateInstance(interactionModal);
                                            interactionModalInstance.show();
                                            console.log('Bootstrap modal shown');
                                        } else if (interactionModal) {
                                            interactionModal.classList.add('show');
                                            interactionModal.style.display = 'block';
                                            console.log('Fallback modal shown');
                                        } else {
                                            console.error('interactionModal not found in DOM after loading');
                                        }
                                    } else {
                                        console.error('renderInteractionModal function is not available after loading modal.');
                                        alert('Could not show session details.');
                                    }
                                });
                            });
                            pillsContainer.appendChild(replanPill);
                        }
                        agentNames.forEach(name => {
                            const agentPill = document.createElement('span');
                            agentPill.className = 'agent-pill blue';
                            agentPill.textContent = name;
                            pillsContainer.appendChild(agentPill);
                        });
                    }
                    bottomSection.appendChild(pillsContainer);
                    
                    // Toxicity button (right side) - only if toxicity data exists
                    if (agentInfo.toxicity && Array.isArray(agentInfo.toxicity) && agentInfo.toxicity.length > 0) {
                        const toxicityContainer = document.createElement('div');
                        toxicityContainer.className = 'toxicity-container';
                        
                        const toxicityToggle = document.createElement('button');
                        toxicityToggle.className = 'btn btn-sm btn-outline-warning toxicity-toggle';
                        toxicityToggle.textContent = 'Show Toxicity';
                        toxicityToggle.onclick = function() {
                            const toxicityContent = toxicityContainer.querySelector('.toxicity-content');
                            if (toxicityContent.style.display === 'none' || !toxicityContent.style.display) {
                                toxicityContent.style.display = 'block';
                                toxicityToggle.textContent = 'Hide Toxicity';
                            } else {
                                toxicityContent.style.display = 'none';
                                toxicityToggle.textContent = 'Show Toxicity';
                            }
                        };
                        
                        const toxicityContent = document.createElement('div');
                        toxicityContent.className = 'toxicity-content';
                        toxicityContent.style.display = 'none';
                        
                        const toxicityPillsContainer = document.createElement('div');
                        toxicityPillsContainer.className = 'toxicity-pills-container';
                        
                        agentInfo.toxicity.forEach(toxicityItem => {
                            const toxicityPill = document.createElement('span');
                            toxicityPill.className = 'toxicity-pill';
                            toxicityPill.textContent = `${toxicityItem.categoryName}: ${toxicityItem.score === 0 ? '0.0' : toxicityItem.score === 1 ? '1.0' : toxicityItem.score.toString()}`;
                            
                            // Color coding based on score
                            if (toxicityItem.score >= 0.7) {
                                toxicityPill.className += ' high';
                            } else if (toxicityItem.score >= 0.4) {
                                toxicityPill.className += ' medium';
                            } else {
                                toxicityPill.className += ' low';
                            }
                            
                            toxicityPillsContainer.appendChild(toxicityPill);
                        });
                        
                        toxicityContent.appendChild(toxicityPillsContainer);
                        toxicityContainer.appendChild(toxicityToggle);
                        toxicityContainer.appendChild(toxicityContent);
                        bottomSection.appendChild(toxicityContainer);
                    }
                    
                    typingMsg.appendChild(bottomSection);
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;
        if (isUser) {
            messageDiv.textContent = message;
        } else {
            const reasoningEngine = window.getReasoningEngine ? window.getReasoningEngine() : 'inference';
            const avatarHtml = window.ENGINE_INFO && window.ENGINE_INFO[reasoningEngine] ? 
                window.ENGINE_INFO[reasoningEngine].svg : defaultAvatar;
            messageDiv.innerHTML = `<div style='display:flex;align-items:flex-start;'><span style='margin-right:8px;'>${avatarHtml}</span><span style='flex:1;'>${marked.parse(message)}</span></div>`;
            
            // Add reasoning button for all agent responses if reasoning exists
            if (responseId && responseReasoningMap.has(responseId)) {
                const reasoningUpdates = responseReasoningMap.get(responseId);
                if (reasoningUpdates.length > 0) {
                    const reasoningContainer = document.createElement('div');
                    reasoningContainer.className = 'reasoning-container';
                    
                    const reasoningToggle = document.createElement('button');
                    reasoningToggle.className = 'btn btn-sm btn-outline-secondary reasoning-toggle';
                    reasoningToggle.textContent = 'Show Chain of Thoughts';
                    reasoningToggle.onclick = function() {
                        const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                        if (reasoningContent.style.display === 'none' || !reasoningContent.style.display) {
                            reasoningContent.style.display = 'block';
                            reasoningToggle.textContent = 'Hide Chain of Thoughts';
                        } else {
                            reasoningContent.style.display = 'none';
                            reasoningToggle.textContent = 'Show Chain of Thoughts';
                        }
                    };
                    
                    const reasoningContent = document.createElement('div');
                    reasoningContent.className = 'reasoning-content';
                    reasoningContent.style.display = 'none';
                    reasoningContent.innerHTML = `<div class="reasoning-updates">${marked.parse(reasoningUpdates.map(update => {
                        const timestamp = update.timestamp ? `[${update.timestamp}] ` : '';
                        return timestamp + update.content;
                    }).join('\n\n'))}</div>`;
                    
                    reasoningContainer.appendChild(reasoningToggle);
                    reasoningContainer.appendChild(reasoningContent);
                    messageDiv.appendChild(reasoningContainer);
                }
            }
            
            // Create bottom section with pills on left and toxicity on right
            if (agentInfo) {
                const bottomSection = document.createElement('div');
                bottomSection.className = 'message-bottom-section';
                
                // Pills logic (left side)
                const pillsContainer = document.createElement('div');
                pillsContainer.className = 'pills-container';
                let agentNames = [];
                if (Array.isArray(agentInfo.reasoning)) {
                    agentInfo.reasoning.forEach(r => {
                        if (Array.isArray(r.calledAgents)) {
                            r.calledAgents.forEach(a => {
                                if (a.agentName && !agentNames.includes(a.agentName)) {
                                    agentNames.push(a.agentName);
                                }
                            });
                        }
                    });
                }
                if (agentNames.length === 0) {
                    const noAgentPill = document.createElement('span');
                    noAgentPill.className = 'agent-pill';
                    noAgentPill.textContent = 'No Remote Agent Used';
                    pillsContainer.appendChild(noAgentPill);
                } else {
                    if (typeof agentInfo.replanCount !== 'undefined' && agentInfo.replanCount !== null) {
                        const replanPill = document.createElement('span');
                        replanPill.className = 'agent-pill green';
                        replanPill.textContent = `Replan Count: ${agentInfo.replanCount}`;
                        replanPill.style.cursor = 'pointer';
                        replanPill.title = 'Click to view session details';
                        replanPill.addEventListener('click', function(e) {
                            console.log('Green replan pill clicked, will load modal');
                            ensureSessionModalLoaded(function() {
                                console.log('ensureSessionModalLoaded callback, about to show modal');
                                if (typeof window.renderInteractionModal === 'function') {
                                    window.renderInteractionModal(agentInfo);
                                    let interactionModal = document.getElementById('interactionModal');
                                    if (window.bootstrap && interactionModal) {
                                        let interactionModalInstance = window.bootstrap.Modal.getOrCreateInstance(interactionModal);
                                        interactionModalInstance.show();
                                        console.log('Bootstrap modal shown');
                                    } else if (interactionModal) {
                                        interactionModal.classList.add('show');
                                        interactionModal.style.display = 'block';
                                        console.log('Fallback modal shown');
                                    } else {
                                        console.error('interactionModal not found in DOM after loading');
                                    }
                                } else {
                                    console.error('renderInteractionModal function is not available after loading modal.');
                                    alert('Could not show session details.');
                                }
                            });
                        });
                        pillsContainer.appendChild(replanPill);
                    }
                    agentNames.forEach(name => {
                        const agentPill = document.createElement('span');
                        agentPill.className = 'agent-pill blue';
                        agentPill.textContent = name;
                        pillsContainer.appendChild(agentPill);
                    });
                }
                bottomSection.appendChild(pillsContainer);
                
                // Toxicity button (right side) - only if toxicity data exists
                if (agentInfo.toxicity && Array.isArray(agentInfo.toxicity) && agentInfo.toxicity.length > 0) {
                    const toxicityContainer = document.createElement('div');
                    toxicityContainer.className = 'toxicity-container';
                    
                    const toxicityToggle = document.createElement('button');
                    toxicityToggle.className = 'btn btn-sm btn-outline-warning toxicity-toggle';
                    toxicityToggle.textContent = 'Show Toxicity';
                    toxicityToggle.onclick = function() {
                        const toxicityContent = toxicityContainer.querySelector('.toxicity-content');
                        if (toxicityContent.style.display === 'none' || !toxicityContent.style.display) {
                            toxicityContent.style.display = 'block';
                            toxicityToggle.textContent = 'Hide Toxicity';
                        } else {
                            toxicityContent.style.display = 'none';
                            toxicityToggle.textContent = 'Show Toxicity';
                        }
                    };
                    
                    const toxicityContent = document.createElement('div');
                    toxicityContent.className = 'toxicity-content';
                    toxicityContent.style.display = 'none';
                    
                    const toxicityPillsContainer = document.createElement('div');
                    toxicityPillsContainer.className = 'toxicity-pills-container';
                    
                    agentInfo.toxicity.forEach(toxicityItem => {
                        const toxicityPill = document.createElement('span');
                        toxicityPill.className = 'toxicity-pill';
                        toxicityPill.textContent = `${toxicityItem.categoryName}: ${toxicityItem.score === 0 ? '0.0' : toxicityItem.score === 1 ? '1.0' : toxicityItem.score.toString()}`;
                        
                        // Color coding based on score
                        if (toxicityItem.score >= 0.7) {
                            toxicityPill.className += ' high';
                        } else if (toxicityItem.score >= 0.4) {
                            toxicityPill.className += ' medium';
                        } else {
                            toxicityPill.className += ' low';
                        }
                        
                        toxicityPillsContainer.appendChild(toxicityPill);
                    });
                    
                    toxicityContent.appendChild(toxicityPillsContainer);
                    toxicityContainer.appendChild(toxicityToggle);
                    toxicityContainer.appendChild(toxicityContent);
                    bottomSection.appendChild(toxicityContainer);
                }
                
                messageDiv.appendChild(bottomSection);
            }
        }
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingMessage() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) {
            console.error('chatMessages element not found in addTypingMessage');
            return;
        }
        
        const oldTyping = document.getElementById('typingMessage');
        if (oldTyping) oldTyping.remove();
        if (typingIntervalId) {
            clearInterval(typingIntervalId);
            typingIntervalId = null;
        }
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message agent-message';
        typingDiv.id = 'typingMessage';
        typingDiv.innerHTML = '<div class="reasoning-updates">Agent is thinking...</div>';
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Public API
    return {
        init: init,
        cleanup: cleanup,
        removeSessionModal: function() {
            const modal = document.getElementById('interactionModal');
            if (modal) {
                modal.setAttribute('inert', '');
                let focusTarget = document.querySelector('.sidebar .nav-link.active') || document.body;
                if (focusTarget) {
                    focusTarget.focus();
                }
                setTimeout(function() {
                    if (window.bootstrap) {
                        let modalInstance = window.bootstrap.Modal.getOrCreateInstance(modal);
                        modal.addEventListener('hidden.bs.modal', function handler() {
                            modal.removeEventListener('hidden.bs.modal', handler);
                            modal.remove();
                            if (window.renderInteractionModal) {
                                delete window.renderInteractionModal;
                            }
                        });
                        modalInstance.hide();
                    } else {
                        modal.remove();
                        if (window.renderInteractionModal) {
                            delete window.renderInteractionModal;
                        }
                    }
                }, 30);
            } else if (window.renderInteractionModal) {
                delete window.renderInteractionModal;
            }
        }
    };
})();

// Initialize the conversation manager
document.addEventListener('DOMContentLoaded', function() {
    // Wait for ENGINE_INFO to be available and DOM to be ready
    const checkEngineInfo = () => {
        if (window.ENGINE_INFO && window.getReasoningEngine) {
            // Additional check to ensure DOM elements are available
            const promptInput = document.getElementById('promptInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            
            if (promptInput && sendButton && chatMessages) {
                if (window.ConversationManager && window.ConversationManager.init) {
                    window.ConversationManager.init();
                }
            } else {
                // DOM elements not ready yet, retry
                setTimeout(checkEngineInfo, 100);
            }
        } else {
            setTimeout(checkEngineInfo, 50); // Check again in 50ms
        }
    };
    checkEngineInfo();
});

// Expose the chat attachment function globally
window.attachConversationChat = function() {
    // Wait for ENGINE_INFO to be available and DOM to be ready
    const checkEngineInfo = () => {
        if (window.ENGINE_INFO && window.getReasoningEngine) {
            // Additional check to ensure DOM elements are available
            const promptInput = document.getElementById('promptInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            
            if (promptInput && sendButton && chatMessages) {
                window.ConversationManager.init();
            } else {
                // DOM elements not ready yet, retry
                setTimeout(checkEngineInfo, 100);
            }
        } else {
            setTimeout(checkEngineInfo, 50); // Check again in 50ms
        }
    };
    checkEngineInfo();
};

// Expose the modal removal function globally
window.removeConversationSessionModal = function() {
    window.ConversationManager.removeSessionModal();
};
</script> 